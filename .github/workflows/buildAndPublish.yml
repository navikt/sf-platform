name: "Build and Publish"
on:
  workflow_call:
  workflow_dispatch:
  workflow_run:
    workflows: ["Run static code validation"]
    types:
      - completed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  buildAndPublish:
    name: Build and Publish
    # Always run on workflow call and workflow dispatch
    # Only run on workflow_run if there has been a change in the src folder,
    # excluding markdown files
    if: ${{
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch' ||
      (
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success'
      )
      }}

    runs-on: ubuntu-latest
    container: ghcr.io/flxbl-io/sfp:${{ vars.SFP_CONTAINER_VERSION }}
    permissions:
      contents: write
      packages: write
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Set Git Config"
        run: |
          git config --global user.email "<>"
          git config --global user.name "GitHub Action"
          git config --system --add safe.directory "$GITHUB_WORKSPACE"

      - name: "Check for changes in src folder"
        run: |
          echo "::group::Check for changes in source code"
          echo "Checking if there has been changes to source code by running git diff on the src folder excluding markdown files"

          changes=$(git diff HEAD^ HEAD --ignore-all-space --name-only -- src/ | grep -v '\.md$')

          if [ -n "$changes" ]; then
            echo "There have been changes to non-Markdown files!"
          else
            echo "No changes to non-Markdown files detected. Cancelling the workflow"
            
            # Use GitHub context variables directly
            REPO="${{ github.repository }}"
            RUN_ID="${{ github.run_id }}"

            # API call to cancel the workflow
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/cancel"

            # Wait for cancellation to be processed
            sleep 5

            echo "Cancellation request sent. Note that cancellation might not be immediate."
            exit 0  # Explicitly exit with success to avoid running further steps if not needed
          fi
          echo "::endgroup::"

      - name: Authenticate node
        uses: navikt/sf-platform/.github/actions/authenticateNode@main
        if: ${{ github.ref_name == 'refs/heads/main' }}

      - name: Authenticate DevHub
        uses: navikt/sf-platform/.github/actions/authenticateOrg@main
        with:
          auth-url: ${{ secrets.SF_DEVHUB_URL }}
          alias: "devhub"
          setDefaultDevhubUsername: "true"

      - name: Validate against CI Pool
        uses: navikt/sf-platform/.github/actions/ciValidate@main
        with:
          devhub: "devhub"
          pools: "ciPlatform"

      - name: Quick build
        uses: navikt/sf-platform/.github/actions/ciQuickBuild@main

      - name: Build
        uses: navikt/sf-platform/.github/actions/build@main

      - name: Publish artifacts
        uses: navikt/sf-platform/.github/actions/publishArtifact@main
        if: ${{ github.ref_name == 'refs/heads/main' }}
        with:
          nodeToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Release Name
        if: ${{ github.ref_name == 'refs/heads/main' }}
        id: generate_name
        run: |
          echo "releaseName=sf-platform_$(date +%s%3N)" >> $GITHUB_OUTPUT

      - name: Generate Release Definition
        if: ${{ github.ref_name == 'refs/heads/main' }}
        uses: navikt/sf-platform/.github/actions/generateReleaseDefinition@main
        with:
          branchToCommitTo: ${{ github.ref }}
          gitRef: ${{ github.ref }}
          pathToConfigFile: config/releaseConfig.yml
          releaseName: ${{ steps.generate_name.outputs.releaseName }}
          directory: "relese-definition"

      - name: Upload artifacts and logs
        uses: navikt/sf-platform/.github/actions/uploadWorkflowArtifactsAndLogs@main
        if: always()
        with:
          artifactName: "build-artifacts"
          uploadArtifacts: true
          logName: "build-logs"
          publishLogs: true
