name: "Build and Publish"
on:
  workflow_call:
    secrets:
      SF_DEVHUB_URL:
        required: true
  push:
    branches:
      - main
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
jobs:
  staticCodeValidation:
    name: Validation jobs
    uses: navikt/sf-platform/.github/workflows/ciStaticCodeValidation.yml@main
    permissions:
      contents: read

  checkChanges:
    name: Check changes
    needs: staticCodeValidation
    runs-on: ubuntu-latest
    outputs:
      hasSrcChanges: ${{ steps.checkChanges.outputs.hasSrcChanges }}
    permissions:
      contents: read
    steps:
      - name: "Checkout"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: navikt/sf-platform/.github/actions/checkForPackageChanges@8a76cf6726f88608113bd6cc313b4a6728ce476a
        id: checkChanges

  buildAndPublish:
    name: Build and Publish
    needs: checkChanges
    if: ${{ github.event_name == 'workflow_dispatch' || needs.checkChanges.outputs.hasSrcChanges == 'true' }}
    runs-on: ubuntu-latest
    container: ghcr.io/flxbl-io/sfp:${{ vars.SFP_CONTAINER_VERSION }}
    permissions:
      contents: write
      packages: write
    steps:
      - name: "Checkout"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Authenticate node
        uses: actions/setup-node@v4
        with:
          registry-url: "https://npm.pkg.github.com"

      - name: Authenticate DevHub
        uses: navikt/sf-platform/.github/actions/authenticateOrg@a0f22eb5d1c9d1ec5e345c04c96a786bd150042a
        with:
          auth-url: ${{ secrets.SF_DEVHUB_URL }}
          alias: "devhub"
          setDefaultDevhubUsername: "true"

      - name: Build
        run: |
          sfp build --devhubalias devhub --diffcheck --buildnumber ${GITHUB_RUN_ID} --branch main --releaseconfig config/releaseConfig.yml --loglevel ${SFP_LOG_LEVEL}
          if [ -d "artifacts" ] && [ -n "$(ls -A artifacts)" ]; then
            echo "Artifacts found"
          else
            echo "No artifacts found"
          fi
        env:
          SFP_LOG_LEVEL: ${{ vars.SFP_LOG_LEVEL }}

      - name: Publish artifacts
        run: |
          if [ -d "artifacts" ] && [ -n "$(ls -A artifacts)" ]; then
            sfp publish --artifactdir artifacts --npm --scope @${SCOPE} --devhubalias devhub --loglevel ${SFP_LOG_LEVEL} --gittag --pushgittag --logsgroupsymbol ::group::,::endgroup::
          else
            echo "No artifacts to publish"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SFP_LOG_LEVEL: ${{ vars.SFP_LOG_LEVEL }}
          SCOPE: ${{ github.repository_owner }}

      - name: Generate Release Name
        id: generate_name
        run: |
          echo "releaseName=sf-platform_$(date +%s%3N)" >> $GITHUB_OUTPUT

      - name: Generate release definition and change log
        id: create_release_files
        run: |
          printf -v red '\033[0;31m'
          printf -v yellow '\033[0;33m'
          printf -v green '\033[0;32m'
          printf -v bold '\033[1m'
          printf -v reset '\033[0m'

          # Debug: Print release name
          echo "${yellow}${bold}Release Name:${reset} ${RELEASE_NAME}"

          # Create the directory for release files
          mkdir -p releases/${RELEASE_NAME}

          echo "${yellow}Generating release definition...${reset}"

          # Generate release definition and save to file
          releaseDefinitionOutput=$(sfp releasedefinition generate \
            --gitref ${GIT_REF} \
            --configfile ${PATH_TO_CONFIG_FILE} \
            --releasename ${RELEASE_NAME} \
            --branchname ${BRANCH_NAME} \
            --loglevel ${SFP_LOG_LEVEL} \
            --nopush)

          echo "$releaseDefinitionOutput"

          echo "$releaseDefinitionOutput" | sed 's/\x1b\[[0-9;]*m//g' \
          | awk '/^release:/,0' > releases/${RELEASE_NAME}/${RELEASE_NAME}.yml

          echo "${yellow}Generating changelog...  ${reset}"

          # Generate changelog
          changelogOutput=$(sfp changelog generate \
            --branchname main \
            --releasename ${RELEASE_NAME} \
            --workitemfilter PTCRM-[0-9] \
            --directory changelog \
            --nopush 2>&1)

          echo "$changelogOutput"
          path=$(echo "$changelogOutput" | grep -oP 'Copying the repository to \K[^ ]+' | head -1)

          # Copy changelog files to release directory
          if [ -n "$path" ] && [ -d "$path/changelog" ]; then
            cp "$path/changelog"/* releases/${RELEASE_NAME}/
          else
            echo "::warning::Path not set or directory does not exist. Tried looking for $path/changelog."
          fi

          files=$(find releases/${RELEASE_NAME} -maxdepth 1 -type f \( -name "*.md" -o -name "*.yml" \) -printf '%p,' | sed 's/,$//')

          # Check if the files was created
          if [ -z "$files" ]; then
            echo "::warning::No files found."
          else
            echo "${yellow}${bold}Files created:${reset}"
            echo "$files"
          fi

          echo "files=$files" >> $GITHUB_OUTPUT

          git config --global --add safe.directory "$GITHUB_WORKSPACE"
        env:
          GIT_REF: ${{ github.sha }}
          PATH_TO_CONFIG_FILE: "config/releaseConfig.yml"
          RELEASE_NAME: ${{ steps.generate_name.outputs.releaseName }}
          BRANCH_NAME: ${{ github.ref_name }}
          SFP_LOG_LEVEL: ${{ vars.SFP_LOG_LEVEL }}

      - name: Commit release files
        uses: navikt/sf-platform/.github/actions/commitFiles@6500f1941a7dcfba4eb8052504dd2c13a35253f5
        with:
          files: ${{ steps.create_release_files.outputs.files }}
          commitMessage: "Release files for ${{ steps.generate_name.outputs.releaseName }}"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Github Release
        run: |
          printf -v red '\033[0;31m'
          printf -v yellow '\033[0;33m'
          printf -v green '\033[0;32m'
          printf -v bold '\033[1m'
          printf -v reset '\033[0m'

          # Create the release and capture the upload URL
          UPLOAD_URL=$(curl -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d '{"tag_name":"'"${RELEASE_NAME}"'","name":"'"${RELEASE_NAME}"'","body":"'"$(cat releases/${RELEASE_NAME}/Release-Changelog.md)"'"}' \
            https://api.github.com/repos/${{ github.repository }}/releases | jq -r '.upload_url' | sed 's/{?name,label}//')

          # Loop through all files in the release directory and upload each
          for file in releases/${RELEASE_NAME}/*; do
            if [ -f "$file" ]; then
              echo "${green}Uploading $file"
              filename=$(basename "$file")
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$file" \
                "$UPLOAD_URL?name=$filename"
            fi
          done
        env:
          RELEASE_NAME: ${{ steps.generate_name.outputs.releaseName }}

      - name: Upload artifacts and logs
        uses: navikt/sf-platform/.github/actions/uploadWorkflowArtifactsAndLogs@f318a266c5a7add9c091f9d3480164fed8abfc08
        with:
          artifactName: "build-artifacts"
          uploadArtifacts: true
          logName: "build-logs"
          publishLogs: true
