name: "Build and Publish"
on:
  workflow_call:
    secrets:
      SF_DEVHUB_URL:
        required: true
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
jobs:
  checkChanges:
    name: Check changes
    runs-on: ubuntu-latest
    outputs:
      continueWorkflow: ${{ steps.checkChanges.outputs.continueWorkflow }}
    permissions:
      contents: read
    steps:
      - name: "Checkout"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: "Check changes since last commit in src folder"
        id: checkChanges
        run: |
          printf -v red '\033[0;31m'
          printf -v yellow '\033[0;33m'
          printf -v green '\033[0;32m'
          printf -v bold '\033[1m'
          printf -v reset '\033[0m'
          printf -v newLine '\n'

          continueWorkflow=true
          changes=""
          nonMarkdownChanges=""

          echo "${yellow}${bold}------------------------------------------------------------------------------------------${reset}"
          echo "${yellow}${bold}Check changes since last commit in src folder${reset}"
          echo "${yellow}${bold}------------------------------------------------------------------------------------------${reset}"

          if [ "${EVENT_NAME}" = "pull_request" ]; then
            changes=$(git diff "${PR_BASE_SHA}".."${PR_HEAD_SHA}" --ignore-all-space --name-only -- src/)
          else
            # Fetch the parent commit SHA dynamically, ensuring we're always looking at the immediate predecessor.
            changes=$(git diff $(git rev-parse "${REF_NAME}^") "${REF_NAME}" --ignore-all-space --name-only -- src/)
          fi

          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            echo "${yellow}${bold}------------------------------------------------------------------------------------------${reset}"
            echo "${yellow}${bold}Manual run. Start building ðŸ—ï¸${reset}"
            echo "${yellow}${bold}------------------------------------------------------------------------------------------${reset}"
          else
            echo "${yellow}Checking if there has been changes to source code by running git diff on the src folder excluding markdown files${reset}"

            if [ -n "$changes" ]; then
              nonMarkdownChanges=$(echo $changes  | grep -v '\.md$')

              if [ -n "$nonMarkdownChanges" ]; then
                echo "${green}${bold}There have been changes to non-Markdown files! Start building ðŸ—ï¸${reset}"
              else
                echo "${yellow}No changes to non-Markdown files detected.${reset}"
                echo "${yellow}Cancelling the workflow${reset}"
                continueWorkflow=false
              fi
            else
              echo "${yellow}No changes to files in src folder. Cancelling the workflow${reset}"
              continueWorkflow=false
            fi

            echo "${yellow}${bold}------------------------------------------------------------------------------------------${reset}"
          fi

          echo "continueWorkflow=$continueWorkflow" >> "$GITHUB_OUTPUT"
        env:
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          REF_NAME: ${{ github.ref_name }}
          EVENT_NAME: ${{ github.event_name }}

  buildAndPublish:
    name: Build and Publish
    needs: checkChanges
    if: ${{ needs.checkChanges.outputs.continueWorkflow == 'true' }}
    runs-on: ubuntu-latest
    container: ghcr.io/flxbl-io/sfp:${{ vars.SFP_CONTAINER_VERSION }}
    permissions:
      contents: write
      packages: write
    steps:
      - name: "Checkout"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Authenticate node
        if: ${{ github.ref_name == 'main' }}
        uses: navikt/sf-platform/.github/actions/authenticateNode@f318a266c5a7add9c091f9d3480164fed8abfc08

      - name: Authenticate DevHub
        uses: navikt/sf-platform/.github/actions/authenticateOrg@f318a266c5a7add9c091f9d3480164fed8abfc08
        with:
          auth-url: ${{ secrets.SF_DEVHUB_URL }}
          alias: "devhub"
          setDefaultDevhubUsername: "true"

      - name: Validate against CI Pool
        uses: navikt/sf-platform/.github/actions/ciValidate@f318a266c5a7add9c091f9d3480164fed8abfc08
        with:
          devhub: "devhub"
          pools: "ciPlatform"
          ref: ${{ github.event_name == 'pull_request' && github.sha || '' }}
          baseRef: ${{ github.event_name == 'pull_request' && github.sha || '' }}

      - name: Quick build
        if: ${{ github.ref_name != 'main' }}
        uses: navikt/sf-platform/.github/actions/ciQuickBuild@f318a266c5a7add9c091f9d3480164fed8abfc08

      - name: Build
        if: ${{ github.ref_name == 'main' }}
        uses: navikt/sf-platform/.github/actions/build@f318a266c5a7add9c091f9d3480164fed8abfc08

      - name: Publish artifacts
        if: ${{ github.ref_name == 'main' }}
        uses: navikt/sf-platform/.github/actions/publishArtifact@f318a266c5a7add9c091f9d3480164fed8abfc08
        with:
          nodeToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Release Name
        if: ${{ github.ref_name == 'main' }}
        id: generate_name
        run: |
          echo "releaseName=sf-platform_$(date +%s%3N)" >> $GITHUB_OUTPUT

      - name: Generate Release Definition
        if: ${{ github.ref_name == 'main' }}
        run: |
          sfp releasedefinition generate --gitref ${GIT_REF} --configfile ${PATH_TO_CONFIG_FILE} --releasename ${RELEASE_NAME} --directory ${DIRECTORY} --branchname ${BRANCH_NAME}
        env:
          GIT_REF: ${{ github.sha }}
          PATH_TO_CONFIG_FILE: "config/releaseConfig.yml"
          RELEASE_NAME: ${{ steps.generate_name.outputs.releaseName }}
          DIRECTORY: "release-definition"
          BRANCH_NAME: ${{ github.ref_name }}

      - name: Commit release definition
        if: ${{ github.ref_name == 'main' }}
        uses: navikt/sf-platform/.github/actions/commitFiles@f318a266c5a7add9c091f9d3480164fed8abfc08
        with:
          files: "release-definition/${{ steps.generate_name.outputs.releaseName }}.yml"

      - name: Upload artifacts and logs
        if: always()
        uses: navikt/sf-platform/.github/actions/uploadWorkflowArtifactsAndLogs@f318a266c5a7add9c091f9d3480164fed8abfc08
        with:
          artifactName: "build-artifacts"
          uploadArtifacts: true
          logName: "build-logs"
          publishLogs: true
