name: "Build and Publish"
on:
  workflow_call:
    secrets:
      SF_DEVHUB_URL:
        required: true
  push:
    branches:
      - main
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
jobs:
  staticCodeValidation:
    name: Validation jobs
    uses: navikt/sf-platform/.github/workflows/ciStaticCodeValidation.yml@main
    permissions:
      contents: read

  checkChanges:
    name: Check changes
    needs: staticCodeValidation
    runs-on: ubuntu-latest
    outputs:
      hasSrcChanges: ${{ steps.checkChanges.outputs.hasSrcChanges }}
    permissions:
      contents: read
    steps:
      - name: "Checkout"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: navikt/sf-platform/.github/actions/checkForPackageChanges@0492f69f72c9d66d98552ee9d62d85511efe21ec
        id: checkChanges

  buildAndPublish:
    name: Build and Publish
    needs: checkChanges
    if: ${{ github.event_name == 'workflow_dispatch' || needs.checkChanges.outputs.hasSrcChanges == 'true' }}
    runs-on: ubuntu-latest
    container: ghcr.io/flxbl-io/sfp:${{ vars.SFP_CONTAINER_VERSION }}
    permissions:
      contents: write
      packages: write
    steps:
      - name: "Checkout"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Authenticate node
        uses: actions/setup-node@v4
        with:
          registry-url: "https://npm.pkg.github.com"

      - name: Authenticate DevHub
        uses: navikt/sf-platform/.github/actions/authenticateOrg@0492f69f72c9d66d98552ee9d62d85511efe21ec
        with:
          auth-url: ${{ secrets.SF_DEVHUB_URL }}
          alias: "devhub"
          setDefaultDevhubUsername: "true"

      - name: Build
        run: |
          sfp build --devhubalias devhub --diffcheck --buildnumber ${GITHUB_RUN_ID} --branch main --releaseconfig config/releaseConfig.yml --loglevel ${SFP_LOG_LEVEL}
          if [ -d "artifacts" ] && [ -n "$(ls -A artifacts)" ]; then
            echo "Artifacts found"
          else
            echo "No artifacts found"
          fi
        env:
          SFP_LOG_LEVEL: ${{ vars.SFP_LOG_LEVEL }}

      - name: Publish artifacts
        run: |
          if [ -d "artifacts" ] && [ -n "$(ls -A artifacts)" ]; then
            sfp publish --artifactdir artifacts --npm --scope @${SCOPE} --devhubalias devhub --loglevel ${SFP_LOG_LEVEL} --gittag --pushgittag --logsgroupsymbol ::group::,::endgroup::
          else
            echo "No artifacts to publish"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SFP_LOG_LEVEL: ${{ vars.SFP_LOG_LEVEL }}
          SCOPE: ${{ github.repository_owner }}

      - name: Generate Release Name
        id: generate_name
        run: |
          echo "releaseName=sf-platform_$(date +%s%3N)" >> $GITHUB_OUTPUT

      - name: Generate release definition and change log
        run: |
          # Debug: Print release name
          echo "Release Name: ${RELEASE_NAME}"

          # Create the directory for release files
          mkdir -p releases/${RELEASE_NAME}

          # Generate release definition and save to file
          sfp releasedefinition generate \
            --gitref ${GIT_REF} \
            --configfile ${PATH_TO_CONFIG_FILE} \
            --releasename ${RELEASE_NAME} \
            --branchname ${BRANCH_NAME} \
            --loglevel ${SFP_LOG_LEVEL} \
            --nopush \
          | sed 's/\x1b\[[0-9;]*m//g' \
          | awk '/^release:/,0' > releases/${RELEASE_NAME}/${RELEASE_NAME}.yaml

          # Generate changelog
          path=$(sfp changelog generate --branchname main --releasename ${RELEASE_NAME} --workitemfilter PTCRM-[0-9] --nopush --directory changelog | grep -oP 'Copying the repository to \K[^ ]+' | head -1)

          if [ -n "$path" ] && [ -d "$path/changelog" ]; then
            cp "$path/changelog"/* releases/${RELEASE_NAME}/
          else
              echo "Error: Path not set or directory does not exist. Tried looking for $path/changelog"
          fi

          # Check if the files was created
          echo "Files created:"
          ls -A1 releases/${RELEASE_NAME}

          git config --global --add safe.directory "$GITHUB_WORKSPACE"
        env:
          GIT_REF: ${{ github.sha }}
          PATH_TO_CONFIG_FILE: "config/releaseConfig.yml"
          RELEASE_NAME: ${{ steps.generate_name.outputs.releaseName }}
          BRANCH_NAME: ${{ github.ref_name }}
          SFP_LOG_LEVEL: ${{ vars.SFP_LOG_LEVEL }}

      - name: Commit release files
        uses: navikt/sf-platform/.github/actions/commitFiles@0492f69f72c9d66d98552ee9d62d85511efe21ec
        with:
          files: releases/${{ steps.generate_name.outputs.releaseName }}/${{ steps.generate_name.outputs.releaseName }}.yml, releases/${{ steps.generate_name.outputs.releaseName }}/Release-Changelog.md
          commitMessage: "Release files for ${{ steps.generate_name.outputs.releaseName }}"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Github Release
        run: |
          UPLOAD_URL=$(curl -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d '{"tag_name":"'"${RELEASE_NAME}"'","name":"'"${RELEASE_NAME}"'","body":"'"$(cat releases/${RELEASE_NAME}/Release-Changelog.md)"'"}' \
            https://api.github.com/repos/${{ github.repository }}/releases | jq -r '.upload_url' | sed 's/{?name,label}//')

          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @releases/${RELEASE_NAME}/${RELEASE_NAME}.yaml \
            "$UPLOAD_URL?name=${RELEASE_NAME}.yaml"

          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @releases/${RELEASE_NAME}/Release-Changelog.md \
            "$UPLOAD_URL?name=Release-Changelog.md"
        env:
          RELEASE_NAME: ${{ steps.generate_name.outputs.releaseName }}

      - name: Upload artifacts and logs
        if: always()
        uses: navikt/sf-platform/.github/actions/uploadWorkflowArtifactsAndLogs@0492f69f72c9d66d98552ee9d62d85511efe21ec
        with:
          artifactName: "build-artifacts"
          uploadArtifacts: true
          logName: "build-logs"
          publishLogs: true
